<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="copyright" content="Copyright © 2025 Scott Anthony Robson">
    <title>WSPR Globe</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Sidebar Toggle Button (for mobile and collapsed state) -->
    <button class="sidebar-toggle" id="sidebarToggle" title="Toggle sidebar">☰</button>

    <!-- Left Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h1>WSPR Globe</h1>
            <button class="sidebar-close" id="sidebarClose" title="Close sidebar">✕</button>
        </div>

        <!-- How to Use Accordion -->
        <div class="accordion">
            <button class="accordion-header" id="howToUseToggle">
                <span>How to Use</span>
                <span class="accordion-icon">▼</span>
            </button>
            <div class="accordion-content" id="howToUseContent">
                <div class="how-to-content">
                    <h3>Getting Started</h3>
                    <p>WSPR Globe visualizes WSPR (Weak Signal Propagation Reporter) spots on an interactive 3D globe. Each arc represents a radio propagation path between a transmitter and receiver.</p>
                    
                    <h3>Searching for Spots</h3>
                    <ul>
                        <li><strong>Call Signs:</strong> Enter a receiver or transmitter call sign to filter spots. Leave empty to see all spots.</li>
                        <li><strong>Time Window:</strong> Select the duration of the time window to search (from 5 minutes to 7 days).</li>
                        <li><strong>Days Ago:</strong> Offset the time window by selecting how many days in the past to search (0-7 days).</li>
                        <li><strong>Hours Ago:</strong> Add an additional hour offset (0-23 hours). Combined with Days Ago, this allows precise time window positioning. The time window finishes at the offset point and extends backward by the selected duration. For example, "15 Minutes" with "2 Days Ago" and "4 Hours Ago" searches for a 15-minute window that finishes at 2 days and 4 hours ago (and starts 15 minutes before that).</li>
                        <li><strong>Frequency Bands:</strong> Check/uncheck bands to include or exclude specific frequencies.</li>
                        <li><strong>Load WSPR Spots:</strong> Click the button to fetch and display spots matching your criteria.</li>
                    </ul>
                    
                    <h3>Display Modes</h3>
                    <ul>
                        <li><strong>Arc Mode:</strong> Shows propagation paths as arcs between TX and RX locations. Arcs peak at ~300 km altitude.</li>
                        <li><strong>Beacon Mode:</strong> Tracks a moving transmitter over time, showing its location at each 2-minute interval.</li>
                        <li><strong>Heatmap Mode:</strong> Color-codes regions by contact density (most active areas are brightest).</li>
                    </ul>
                    
                    <h3>Time-Lapse Animation</h3>
                    <ul>
                        <li><strong>Enable Time-Lapse:</strong> Check "Time-lapse animation" to animate through your loaded spots over time.</li>
                        <li><strong>Window Size:</strong> Select the time window shown in each frame (2 minutes to 1 hour). This creates a sliding window that moves through your data.</li>
                        <li><strong>Animation Speed:</strong> Choose from 1x (real-time) up to 10,000x to compress hours or days of data into a short viewing time.</li>
                        <li><strong>Controls:</strong> Use Play/Pause to control animation, Reset to return to the start, and the progress slider to jump to any point in time.</li>
                        <li><strong>Note:</strong> When time-lapse is active, "Animate lines" is automatically disabled to prevent jerky animation. Heatmap mode may not work smoothly during time-lapse animation due to rendering performance limitations.</li>
                    </ul>
                    
                    <h3>Visualization Options</h3>
                    <ul>
                        <li><strong>Max Spots to Download:</strong> Limits how many spots are downloaded from the database (100 to 100,000 spots). This helps control data size and query performance.</li>
                        <li><strong>Max Lines to Display:</strong> Limits the number of unique paths to display after deduplication. If you have more unique paths than the limit, a random sample will be selected. Options: All, 200, 500, 1,000, 2,000, or 5,000 paths. This applies to both arc rendering and heatmap generation.</li>
                        <li><strong>Animate Lines:</strong> Adds a moving "dot dot dot" pattern along arcs. Automatically disabled during time-lapse animation.</li>
                        <li><strong>Solid Lines:</strong> Makes arcs fully opaque (default is semi-transparent).</li>
                        <li><strong>Show TX/RX Markers:</strong> Displays solid circles at transmitters and open circles at receivers.</li>
                    </ul>
                    
                    <h3>Interacting with the Globe</h3>
                    <ul>
                        <li><strong>Rotate:</strong> Click and drag to rotate the globe.</li>
                        <li><strong>Zoom:</strong> Scroll to zoom in/out.</li>
                        <li><strong>Details:</strong> Click on any arc or point to see spot details (callsigns, distance, frequency, SNR, power, time).</li>
                    </ul>
                    
                    <h3>Statistics Panel</h3>
                    <p>After loading spots, view statistics including total spots, unique paths, furthest contact distance, most active band, and SNR metrics.</p>
                    
                    <h3>Sharing Links with URL Parameters</h3>
                    <p>You can share links that automatically populate fields and optionally auto-load spots. Add parameters to the URL like this:</p>
                    <p><code>?tx=K6AUS&window=60&autoLoad=1</code></p>
                    
                    <h4>Available URL Parameters:</h4>
                    <ul>
                        <li><strong>rx</strong> - Receiver call sign (e.g., <code>?rx=K6AUS</code>)</li>
                        <li><strong>tx</strong> - Transmitter call sign (e.g., <code>?tx=W1AW</code>)</li>
                        <li><strong>window</strong> - Time window in minutes (e.g., <code>?window=60</code> for 1 hour)</li>
                        <li><strong>days</strong> - Days ago offset (0-7, e.g., <code>?days=1</code>)</li>
                        <li><strong>hours</strong> - Hours ago offset (0-23, e.g., <code>?hours=4</code>)</li>
                        <li><strong>maxSpots</strong> - Max spots to download (e.g., <code>?maxSpots=5000</code>)</li>
                        <li><strong>maxLines</strong> - Max lines to display: all, 200, 500, 1000, 2000, or 5000 (e.g., <code>?maxLines=500</code>)</li>
                        <li><strong>bands</strong> - Comma-separated frequency bands (e.g., <code>?bands=14,21,28</code> for 14, 21, and 28 MHz)</li>
                        <li><strong>animateLines</strong> - Animate lines: 1 or 0 (e.g., <code>?animateLines=1</code>)</li>
                        <li><strong>solidLines</strong> - Solid lines (no transparency): 1 or 0</li>
                        <li><strong>showMarkers</strong> - Show TX/RX markers: 1 or 0 (default is 1)</li>
                        <li><strong>heatmap</strong> - Enable heatmap mode: 1 or 0</li>
                        <li><strong>beacon</strong> - Enable beacon mode: 1 or 0</li>
                        <li><strong>timelapse</strong> - Enable time-lapse animation: 1 or 0</li>
                        <li><strong>timelapseWindow</strong> - Time-lapse window size in minutes (e.g., <code>?timelapseWindow=10</code>)</li>
                        <li><strong>timelapseSpeed</strong> - Time-lapse speed multiplier (e.g., <code>?timelapseSpeed=2000</code>)</li>
                        <li><strong>autoLoad</strong> - Automatically load spots on page load: 1 or 0 (e.g., <code>?autoLoad=1</code>)</li>
                    </ul>
                    
                    <h4>Example URLs:</h4>
                    <ul>
                        <li><code>?tx=K6AUS&window=60&autoLoad=1</code> - Auto-loads with transmitter K6AUS and 1-hour window</li>
                        <li><code>?rx=K6AUS&bands=14,21,28&heatmap=1&autoLoad=1</code> - Auto-loads with receiver K6AUS, specific bands, and heatmap mode</li>
                        <li><code>?tx=W1AW&window=240&maxSpots=10000&maxLines=2000&autoLoad=1</code> - Auto-loads with custom limits</li>
                    </ul>
                </div>
            </div>
        </div>

        <h2>Call Sign Filters</h2>
        <div class="form-group">
            <label for="rxCallsign">Receiver Call Sign</label>
            <input type="text" id="rxCallsign" placeholder="K6AUS" style="text-transform: uppercase;">
            <div class="help-text">Leave empty for all receivers</div>
        </div>

        <div class="form-group">
            <label for="txCallsign">Transmitter Call Sign</label>
            <input type="text" id="txCallsign" placeholder="K6AUS" style="text-transform: uppercase;">
            <div class="help-text">Leave empty for all transmitters</div>
        </div>

        <h2>Time Range</h2>
        <div class="form-group">
            <label for="timeWindow">Time Window</label>
            <select id="timeWindow">
                <option value="5">5 Minutes</option>
                <option value="15" selected>15 Minutes</option>
                <option value="30">30 Minutes</option>
                <option value="60">1 Hour</option>
                <option value="240">4 Hours</option>
                <option value="480">8 Hours</option>
                <option value="720">12 Hours</option>
                <option value="1440">24 Hours</option>
                <option value="4320">3 Days</option>
                <option value="10080">7 Days</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="hoursAgo">Hours Ago</label>
            <select id="hoursAgo">
                <option value="0" selected>Now</option>
                <option value="1">1 Hour Ago</option>
                <option value="2">2 Hours Ago</option>
                <option value="3">3 Hours Ago</option>
                <option value="4">4 Hours Ago</option>
                <option value="5">5 Hours Ago</option>
                <option value="6">6 Hours Ago</option>
                <option value="7">7 Hours Ago</option>
                <option value="8">8 Hours Ago</option>
                <option value="9">9 Hours Ago</option>
                <option value="10">10 Hours Ago</option>
                <option value="11">11 Hours Ago</option>
                <option value="12">12 Hours Ago</option>
                <option value="13">13 Hours Ago</option>
                <option value="14">14 Hours Ago</option>
                <option value="15">15 Hours Ago</option>
                <option value="16">16 Hours Ago</option>
                <option value="17">17 Hours Ago</option>
                <option value="18">18 Hours Ago</option>
                <option value="19">19 Hours Ago</option>
                <option value="20">20 Hours Ago</option>
                <option value="21">21 Hours Ago</option>
                <option value="22">22 Hours Ago</option>
                <option value="23">23 Hours Ago</option>
            </select>
            <div class="help-text">Additional hour offset (combined with days)</div>
        </div>
        
        <div class="form-group">
            <label for="daysAgo">Days Ago</label>
            <select id="daysAgo">
                <option value="0" selected>Today</option>
                <option value="1">1 Day Ago</option>
                <option value="2">2 Days Ago</option>
                <option value="3">3 Days Ago</option>
                <option value="4">4 Days Ago</option>
                <option value="5">5 Days Ago</option>
                <option value="6">6 Days Ago</option>
                <option value="7">7 Days Ago</option>
            </select>
            <div class="help-text">Offset the time window by this many days</div>
        </div>

        <h2>Display Options</h2>
        <div class="form-group">
            <label for="maxLines">Max Spots to Download</label>
            <select id="maxLines">
                <option value="100">100 Spots</option>
                <option value="500">500 Spots</option>
                <option value="1000" selected>1,000 Spots</option>
                <option value="5000">5,000 Spots</option>
                <option value="10000">10,000 Spots</option>
                <option value="25000">25,000 Spots</option>
                <option value="50000">50,000 Spots</option>
                <option value="100000">100,000 Spots</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="maxLinesToDisplay">Max Lines to Display</label>
            <select id="maxLinesToDisplay">
                <option value="all" selected>All</option>
                <option value="200">200</option>
                <option value="500">500</option>
                <option value="1000">1,000</option>
                <option value="2000">2,000</option>
                <option value="5000">5,000</option>
            </select>
            <div class="help-text">Randomly sample unique paths if limit is exceeded</div>
        </div>

        <div class="form-group checkbox-group">
            <label class="checkbox-label">
                <input type="checkbox" id="beaconMode">
                <span>Beacon mode (track TX location)</span>
            </label>
        </div>

        <div id="arcOptions">
            <div class="form-group checkbox-group">
                <label class="checkbox-label">
                    <input type="checkbox" id="animateLines" checked>
                    <span>Animate lines</span>
                </label>
            </div>

            <div class="form-group checkbox-group">
                <label class="checkbox-label">
                    <input type="checkbox" id="solidLines">
                    <span>Solid lines (no transparency)</span>
                </label>
            </div>

            <div class="form-group checkbox-group">
                <label class="checkbox-label">
                    <input type="checkbox" id="showMarkers" checked>
                    <span>Show TX/RX markers</span>
                </label>
            </div>

            <div class="form-group checkbox-group">
                <label class="checkbox-label">
                    <input type="checkbox" id="heatmapMode">
                    <span>Heatmap mode</span>
                </label>
            </div>

            <div class="form-group checkbox-group">
                <label class="checkbox-label">
                    <input type="checkbox" id="timelapseMode">
                    <span>Time-lapse animation</span>
                </label>
            </div>

        </div>

        <!-- Time-lapse Controls -->
        <div id="timelapseControls" class="timelapse-controls" style="display: none;">
            <div class="form-group">
                <label for="timelapseWindow">Window Size</label>
                <select id="timelapseWindow">
                    <option value="2">2 Minutes</option>
                    <option value="5">5 Minutes</option>
                    <option value="10" selected>10 Minutes</option>
                    <option value="15">15 Minutes</option>
                    <option value="30">30 Minutes</option>
                    <option value="60">1 Hour</option>
                </select>
                <div class="help-text">Time window shown in each frame</div>
            </div>
            
            <div class="form-group">
                <label for="timelapseSpeed">Animation Speed</label>
                <select id="timelapseSpeed">
                    <option value="1">1x (Real-time)</option>
                    <option value="10">10x</option>
                    <option value="50">50x</option>
                    <option value="100">100x</option>
                    <option value="500">500x</option>
                    <option value="1000">1,000x</option>
                    <option value="2000" selected>2,000x (Fast)</option>
                    <option value="5000">5,000x (Very Fast)</option>
                    <option value="10000">10,000x (Ultra Fast)</option>
                </select>
            </div>
            
            <div class="timelapse-buttons">
                <button class="btn btn-secondary" id="timelapsePlayPause">▶ Play</button>
                <button class="btn btn-secondary" id="timelapseReset">⟲ Reset</button>
            </div>
            
            <div class="timelapse-time">
                <div class="timelapse-time-label">Time:</div>
                <div class="timelapse-time-value" id="timelapseTimeDisplay">--:--</div>
            </div>
            
            <div class="timelapse-progress">
                <input type="range" id="timelapseProgress" min="0" max="100" value="0" class="timelapse-slider">
            </div>
        </div>

        <button class="btn btn-primary" id="loadBtn">Load WSPR Spots</button>

        <div class="status" id="status">Ready to search</div>

        <!-- Stats Panel -->
        <div class="stats-panel" id="statsPanel" style="display: none;">
            <h2>Statistics</h2>
            <div class="stat-row">
                <span class="stat-label">Total Spots</span>
                <span class="stat-value" id="statTotalSpots">-</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Unique Paths</span>
                <span class="stat-value" id="statUniquePaths">-</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Furthest Contact</span>
                <span class="stat-value" id="statFurthest">-</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Most Active Band</span>
                <span class="stat-value" id="statActiveBand">-</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Avg SNR</span>
                <span class="stat-value" id="statAvgSNR">-</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Best SNR</span>
                <span class="stat-value" id="statBestSNR">-</span>
            </div>
        </div>

        <div class="band-legend" id="frequencyLegend">
            <h2>Frequency Bands <button class="btn-small" id="selectAllBands">All</button> <button class="btn-small" id="selectNoBands">None</button></h2>
            <div class="band-filter">
                <label class="band-checkbox"><input type="checkbox" data-band="0.137" checked><span class="band-color" style="background: #ff0000;"></span>137 kHz</label>
                <label class="band-checkbox"><input type="checkbox" data-band="0.475" checked><span class="band-color" style="background: #ff6600;"></span>475 kHz</label>
                <label class="band-checkbox"><input type="checkbox" data-band="1.8" checked><span class="band-color" style="background: #ffcc00;"></span>1.8 MHz</label>
                <label class="band-checkbox"><input type="checkbox" data-band="3.5" checked><span class="band-color" style="background: #99ff00;"></span>3.5 MHz</label>
                <label class="band-checkbox"><input type="checkbox" data-band="7" checked><span class="band-color" style="background: #00ff00;"></span>7 MHz</label>
                <label class="band-checkbox"><input type="checkbox" data-band="10" checked><span class="band-color" style="background: #00ff99;"></span>10 MHz</label>
                <label class="band-checkbox"><input type="checkbox" data-band="14" checked><span class="band-color" style="background: #00ffff;"></span>14 MHz</label>
                <label class="band-checkbox"><input type="checkbox" data-band="18" checked><span class="band-color" style="background: #0099ff;"></span>18 MHz</label>
                <label class="band-checkbox"><input type="checkbox" data-band="21" checked><span class="band-color" style="background: #0000ff;"></span>21 MHz</label>
                <label class="band-checkbox"><input type="checkbox" data-band="28" checked><span class="band-color" style="background: #9900ff;"></span>28 MHz</label>
                <label class="band-checkbox"><input type="checkbox" data-band="50" checked><span class="band-color" style="background: #ff00ff;"></span>50 MHz</label>
                <label class="band-checkbox"><input type="checkbox" data-band="144" checked><span class="band-color" style="background: #ff0099;"></span>144 MHz</label>
            </div>
        </div>

        <div class="band-legend" id="beaconLegend" style="display: none;">
            <h2>Beacon Time Gradient</h2>
            <div class="time-gradient">
                <div class="gradient-bar"></div>
                <div class="gradient-labels">
                    <span>Oldest</span>
                    <span>Newest</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="site-header">
        <div class="header-content">
            <div class="time-window-display" id="timeWindowDisplay"></div>
        </div>
    </header>

    <!-- Globe Container -->
    <div id="globeContainer">
        <div class="globe-info">Drag to rotate • Scroll to zoom • Click arc for details</div>
    </div>

    <!-- Spot Details Popup -->
    <div class="spot-popup" id="spotPopup">
        <button class="popup-close" id="popupClose">✕</button>
        <div class="popup-content" id="popupContent"></div>
    </div>

    <!-- Footer -->
    <footer class="site-footer">
        <div class="footer-content">
            <p>Copyright © <span id="copyrightYear">2025</span> Scott Anthony Robson - Licensed under <a href="LICENSE" target="_blank">MIT License</a> - Attribution required for use and modifications</p>
        </div>
    </footer>

    <script src="https://unpkg.com/globe.gl"></script>
    <script src="app.js"></script>
    <script>
        // Update copyright year dynamically
        document.getElementById('copyrightYear').textContent = new Date().getFullYear();
    </script>
</body>
</html>
