<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="copyright" content="Copyright ¬© 2025 Scott Anthony Robson">
    <title>WSPR Globe</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Sidebar Toggle Button (for mobile and collapsed state) -->
    <button class="sidebar-toggle" id="sidebarToggle" title="Toggle sidebar">‚ò∞</button>

    <!-- Left Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h1>WSPR Globe</h1>
            <button class="sidebar-close" id="sidebarClose" title="Close sidebar">‚úï</button>
        </div>

        <!-- How to Use Accordion -->
        <div class="accordion">
            <button class="accordion-header" id="howToUseToggle">
                <span>How to Use</span>
                <span class="accordion-icon">‚ñº</span>
            </button>
            <div class="accordion-content" id="howToUseContent">
                <div class="how-to-content">
                    <h3>Quick Start</h3>
                    <ol>
                        <li>Optionally set <strong>Receiver</strong> and/or <strong>Transmitter</strong> call signs (leave blank for ‚Äúall‚Äù).</li>
                        <li>Choose a <strong>time window</strong> (e.g., 15 minutes) and optional <strong>Days Ago</strong> / <strong>Hours Ago</strong> offsets.</li>
                        <li>Select one or more <strong>frequency bands</strong>.</li>
                        <li>Click <strong>Load WSPR Spots</strong>.</li>
                    </ol>

                    <h3>Understanding What You See</h3>
                    <ul>
                        <li><strong>Arcs</strong>: a propagation path from TX ‚Üí RX, color-coded by band.</li>
                        <li><strong>Markers</strong> (if enabled): solid circles are TX locations; open circles are RX locations.</li>
                        <li><strong>Click for details</strong>: click any arc or point to see the underlying spot info (callsigns, time, frequency, distance, SNR, power, etc.).</li>
                    </ul>

                    <h3>Search & Filters</h3>
                    <ul>
                        <li><strong>Call sign filters</strong>: set <strong>Receiver</strong> and/or <strong>Transmitter</strong> to narrow the search.</li>
                        <li><strong>Time window</strong>: the duration of the window you want to visualize.</li>
                        <li><strong>Days Ago / Hours Ago offsets</strong>: the window <em>ends</em> at ‚Äúnow minus (days + hours)‚Äù, and extends backward by the selected window size.
                            <br><em>Example:</em> ‚Äú15 Minutes‚Äù + ‚Äú2 Days Ago‚Äù + ‚Äú4 Hours Ago‚Äù searches a 15-minute window ending 2 days and 4 hours ago.</li>
                        <li><strong>Frequency bands</strong>: check/uncheck bands to include/exclude them (colors in the legend match the globe).</li>
                        <li><strong>Exclude callsigns starting with 0, 1, or Q</strong>: enabled by default to reduce non-amateur / odd entries; uncheck to allow them.</li>
                    </ul>

                    <h3>Display Modes</h3>
                    <ul>
                        <li><strong>Arc mode (default)</strong>: deduplicated TX‚ÜîRX paths are drawn as arcs.</li>
                        <li><strong>Beacon mode</strong>: tracks a moving transmitter over time (best for a single TX).</li>
                        <li><strong>Heatmap mode</strong>: shows contact density (useful for ‚Äúwhere activity is‚Äù, not specific paths).</li>
                        <li><strong>Time-lapse animation</strong> (arc mode): animates a sliding time window through your loaded spots using the play/pause controls and slider.</li>
                    </ul>

                    <h3>Sharing Links</h3>
                    <p>Use the <strong>Share</strong> button to copy a URL that restores your current settings.</p>
                    <h4>Supported URL Parameters</h4>
                    <ul>
                        <li><strong>rx</strong>, <strong>tx</strong></li>
                        <li><strong>window</strong> (minutes), <strong>days</strong> (0‚Äì7), <strong>hours</strong> (0‚Äì23)</li>
                        <li><strong>maxSpots</strong> (download limit), <strong>maxLines</strong> (display limit: all/200/500/1000/2000/5000)</li>
                        <li><strong>bands</strong> (comma-separated: e.g., <code>bands=14,21,28</code>)</li>
                        <li><strong>animateLines</strong>, <strong>solidLines</strong>, <strong>showMarkers</strong>, <strong>heatmap</strong>, <strong>beacon</strong></li>
                        <li><strong>timelapse</strong>, <strong>timelapseWindow</strong>, <strong>timelapseSpeed</strong></li>
                        <li><strong>allowWeird</strong>: set <code>allowWeird=1</code> to allow callsigns starting with 0/1/Q</li>
                        <li><strong>autoLoad</strong>: <code>autoLoad=1</code> loads automatically on page open</li>
                    </ul>
                    <p><em>Note:</em> the day/night terminator toggle currently isn‚Äôt included in shared URLs.</p>

                    <h3>Performance & Rendering Notes</h3>
                    <ul>
                        <li><strong>Too many lines can get slow</strong>: if rendering is choppy, reduce <strong>Max Lines to Display</strong> first (this directly reduces draw calls). Reducing <strong>Max Spots to Download</strong> also helps.</li>
                        <li><strong>Other speed knobs</strong>: turn off <strong>Animate lines</strong>, <strong>Show TX/RX markers</strong>, and/or <strong>Heatmap mode</strong>.</li>
                        <li><strong>Day/night terminator caveats</strong>: the terminator uses a transparent overlay shader and may cause subtle rendering artifacts (e.g., ‚Äúrays‚Äù flickering at the darkness edge on some GPUs/browsers). It can also make the <strong>heatmap look odd</strong> because the night overlay tints/darkens what‚Äôs beneath. If you‚Äôre evaluating heatmap intensity, consider turning the terminator off.</li>
                    </ul>
                </div>
            </div>
        </div>

        <h2>Call Sign Filters</h2>
        <div class="form-group">
            <label for="rxCallsign">Receiver Call Sign</label>
            <input type="text" id="rxCallsign" placeholder="K6AUS" style="text-transform: uppercase;">
            <div class="help-text">Leave empty for all receivers</div>
        </div>

        <div class="form-group">
            <label for="txCallsign">Transmitter Call Sign</label>
            <input type="text" id="txCallsign" placeholder="K6AUS" style="text-transform: uppercase;">
            <div class="help-text">Leave empty for all transmitters</div>
        </div>

        <div class="form-group checkbox-group">
            <label class="checkbox-label">
                <input type="checkbox" id="excludeWeirdCallsigns" checked>
                <span>Exclude callsigns starting with 0, 1, or Q</span>
            </label>
            <div class="help-text">Filters both TX and RX callsigns. Uncheck to allow them.</div>
        </div>

        <h2>Time Range</h2>
        <div class="form-group">
            <label for="timeWindow">Time Window</label>
            <select id="timeWindow">
                <option value="5">5 Minutes</option>
                <option value="15" selected>15 Minutes</option>
                <option value="30">30 Minutes</option>
                <option value="60">1 Hour</option>
                <option value="240">4 Hours</option>
                <option value="480">8 Hours</option>
                <option value="720">12 Hours</option>
                <option value="1440">24 Hours</option>
                <option value="4320">3 Days</option>
                <option value="10080">7 Days</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="hoursAgo">Hours Ago</label>
            <select id="hoursAgo">
                <option value="0" selected>Now</option>
                <option value="1">1 Hour Ago</option>
                <option value="2">2 Hours Ago</option>
                <option value="3">3 Hours Ago</option>
                <option value="4">4 Hours Ago</option>
                <option value="5">5 Hours Ago</option>
                <option value="6">6 Hours Ago</option>
                <option value="7">7 Hours Ago</option>
                <option value="8">8 Hours Ago</option>
                <option value="9">9 Hours Ago</option>
                <option value="10">10 Hours Ago</option>
                <option value="11">11 Hours Ago</option>
                <option value="12">12 Hours Ago</option>
                <option value="13">13 Hours Ago</option>
                <option value="14">14 Hours Ago</option>
                <option value="15">15 Hours Ago</option>
                <option value="16">16 Hours Ago</option>
                <option value="17">17 Hours Ago</option>
                <option value="18">18 Hours Ago</option>
                <option value="19">19 Hours Ago</option>
                <option value="20">20 Hours Ago</option>
                <option value="21">21 Hours Ago</option>
                <option value="22">22 Hours Ago</option>
                <option value="23">23 Hours Ago</option>
            </select>
            <div class="help-text">Additional hour offset (combined with days)</div>
        </div>
        
        <div class="form-group">
            <label for="daysAgo">Days Ago</label>
            <select id="daysAgo">
                <option value="0" selected>Today</option>
                <option value="1">1 Day Ago</option>
                <option value="2">2 Days Ago</option>
                <option value="3">3 Days Ago</option>
                <option value="4">4 Days Ago</option>
                <option value="5">5 Days Ago</option>
                <option value="6">6 Days Ago</option>
                <option value="7">7 Days Ago</option>
            </select>
            <div class="help-text">Offset the time window by this many days</div>
        </div>

        <h2>Display Options</h2>
        <div class="form-group">
            <label for="maxLines">Max Spots to Download</label>
            <select id="maxLines">
                <option value="100">100 Spots</option>
                <option value="500">500 Spots</option>
                <option value="1000" selected>1,000 Spots</option>
                <option value="5000">5,000 Spots</option>
                <option value="10000">10,000 Spots</option>
                <option value="25000">25,000 Spots</option>
                <option value="50000">50,000 Spots</option>
                <option value="100000">100,000 Spots</option>
            </select>
            <div class="help-text">Lower values usually load faster and reduce memory/CPU use</div>
        </div>
        
        <div class="form-group">
            <label for="maxLinesToDisplay">Max Lines to Display</label>
            <select id="maxLinesToDisplay">
                <option value="all" selected>All</option>
                <option value="200">200</option>
                <option value="500">500</option>
                <option value="1000">1,000</option>
                <option value="2000">2,000</option>
                <option value="5000">5,000</option>
            </select>
            <div class="help-text">Randomly sample unique paths if limit is exceeded. Reducing this can greatly improve speed and stability.</div>
        </div>

        <div class="form-group checkbox-group">
            <label class="checkbox-label">
                <input type="checkbox" id="beaconMode">
                <span>Beacon mode (track TX location)</span>
            </label>
        </div>

        <div id="arcOptions">
            <div class="form-group checkbox-group">
                <label class="checkbox-label">
                    <input type="checkbox" id="animateLines" checked>
                    <span>Animate lines</span>
                </label>
            </div>

            <div class="form-group checkbox-group">
                <label class="checkbox-label">
                    <input type="checkbox" id="solidLines">
                    <span>Solid lines (no transparency)</span>
                </label>
            </div>

            <div class="form-group checkbox-group">
                <label class="checkbox-label">
                    <input type="checkbox" id="showMarkers" checked>
                    <span>Show TX/RX markers</span>
                </label>
            </div>

            <div class="form-group checkbox-group">
                <label class="checkbox-label">
                    <input type="checkbox" id="heatmapMode">
                    <span>Heatmap mode</span>
                </label>
                <div class="help-text">Can be slower with large datasets. Consider lowering ‚ÄúMax Lines to Display‚Äù.</div>
            </div>

            <div class="form-group checkbox-group">
                <label class="checkbox-label">
                    <input type="checkbox" id="showTerminator">
                    <span>Day/night terminator (current time)</span>
                </label>
                <div class="help-text">May introduce minor rendering artifacts on some systems and can affect heatmap appearance (dark overlay).</div>
            </div>

            <div class="form-group checkbox-group">
                <label class="checkbox-label">
                    <input type="checkbox" id="timelapseMode">
                    <span>Time-lapse animation</span>
                </label>
            </div>

        </div>

        <!-- Time-lapse Controls -->
        <div id="timelapseControls" class="timelapse-controls" style="display: none;">
            <div class="form-group">
                <label for="timelapseWindow">Window Size</label>
                <select id="timelapseWindow">
                    <option value="2">2 Minutes</option>
                    <option value="5">5 Minutes</option>
                    <option value="10" selected>10 Minutes</option>
                    <option value="15">15 Minutes</option>
                    <option value="30">30 Minutes</option>
                    <option value="60">1 Hour</option>
                </select>
                <div class="help-text">Time window shown in each frame</div>
            </div>
            
            <div class="form-group">
                <label for="timelapseSpeed">Animation Speed</label>
                <select id="timelapseSpeed">
                    <option value="1">1x (Real-time)</option>
                    <option value="10">10x</option>
                    <option value="50">50x</option>
                    <option value="100">100x</option>
                    <option value="500">500x</option>
                    <option value="1000">1,000x</option>
                    <option value="2000" selected>2,000x (Fast)</option>
                    <option value="5000">5,000x (Very Fast)</option>
                    <option value="10000">10,000x (Ultra Fast)</option>
                </select>
            </div>
            
            <div class="timelapse-buttons">
                <button class="btn btn-secondary" id="timelapsePlayPause">‚ñ∂ Play</button>
                <button class="btn btn-secondary" id="timelapseReset">‚ü≤ Reset</button>
            </div>
            
            <div class="timelapse-time">
                <div class="timelapse-time-label">Time:</div>
                <div class="timelapse-time-value" id="timelapseTimeDisplay">--:--</div>
            </div>
            
            <div class="timelapse-progress">
                <input type="range" id="timelapseProgress" min="0" max="100" value="0" class="timelapse-slider">
            </div>
        </div>

        <button class="btn btn-primary" id="loadBtn">Load WSPR Spots</button>
        
        <button class="btn btn-secondary" id="shareBtn" title="Generate shareable link with current settings">üîó Share Link</button>

        <div class="status" id="status">Ready to search</div>

        <!-- Stats Panel -->
        <div class="stats-panel" id="statsPanel" style="display: none;">
            <h2>Statistics</h2>
            <div class="stat-row">
                <span class="stat-label">Total Spots</span>
                <span class="stat-value" id="statTotalSpots">-</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Unique Paths</span>
                <span class="stat-value" id="statUniquePaths">-</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Furthest Contact</span>
                <span class="stat-value" id="statFurthest">-</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Most Active Band</span>
                <span class="stat-value" id="statActiveBand">-</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Avg SNR</span>
                <span class="stat-value" id="statAvgSNR">-</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Best SNR</span>
                <span class="stat-value" id="statBestSNR">-</span>
            </div>
        </div>

        <div class="band-legend" id="frequencyLegend">
            <h2>Frequency Bands <button class="btn-small" id="selectAllBands">All</button> <button class="btn-small" id="selectNoBands">None</button></h2>
            <div class="band-filter">
                <label class="band-checkbox"><input type="checkbox" data-band="0.137" checked><span class="band-color" style="background: #9900ff;"></span>137 kHz</label>
                <label class="band-checkbox"><input type="checkbox" data-band="0.475" checked><span class="band-color" style="background: #6600ff;"></span>475 kHz</label>
                <label class="band-checkbox"><input type="checkbox" data-band="1.8" checked><span class="band-color" style="background: #0000ff;"></span>1.8 MHz</label>
                <label class="band-checkbox"><input type="checkbox" data-band="3.5" checked><span class="band-color" style="background: #0099ff;"></span>3.5 MHz</label>
                <label class="band-checkbox"><input type="checkbox" data-band="7" checked><span class="band-color" style="background: #00ff99;"></span>7 MHz</label>
                <label class="band-checkbox"><input type="checkbox" data-band="10" checked><span class="band-color" style="background: #00ff00;"></span>10 MHz</label>
                <label class="band-checkbox"><input type="checkbox" data-band="14" checked><span class="band-color" style="background: #66ff00;"></span>14 MHz</label>
                <label class="band-checkbox"><input type="checkbox" data-band="18" checked><span class="band-color" style="background: #99ff00;"></span>18 MHz</label>
                <label class="band-checkbox"><input type="checkbox" data-band="21" checked><span class="band-color" style="background: #ffcc00;"></span>21 MHz</label>
                <label class="band-checkbox"><input type="checkbox" data-band="24" checked><span class="band-color" style="background: #ff6600;"></span>24.89 MHz</label>
                <label class="band-checkbox"><input type="checkbox" data-band="28" checked><span class="band-color" style="background: #ff0000;"></span>28 MHz</label>
                <label class="band-checkbox"><input type="checkbox" data-band="50" checked><span class="band-color" style="background: #808080;"></span>50 MHz</label>
                <label class="band-checkbox"><input type="checkbox" data-band="144" checked><span class="band-color" style="background: #ffffff;"></span>144 MHz</label>
            </div>
        </div>

        <div class="band-legend" id="beaconLegend" style="display: none;">
            <h2>Beacon Time Gradient</h2>
            <div class="time-gradient">
                <div class="gradient-bar"></div>
                <div class="gradient-labels">
                    <span>Oldest</span>
                    <span>Newest</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="site-header">
        <div class="header-content">
            <div class="time-window-display" id="timeWindowDisplay"></div>
        </div>
    </header>

    <!-- Globe Container -->
    <div id="globeContainer">
        <div class="globe-info">Drag to rotate ‚Ä¢ Scroll to zoom ‚Ä¢ Click arc for details</div>
    </div>

    <!-- Spot Details Popup -->
    <div class="spot-popup" id="spotPopup">
        <button class="popup-close" id="popupClose">‚úï</button>
        <div class="popup-content" id="popupContent"></div>
    </div>

    <!-- Footer -->
    <footer class="site-footer">
        <div class="footer-content">
            <p>Copyright ¬© <span id="copyrightYear">2025</span> Scott Anthony Robson - Licensed under <a href="LICENSE" target="_blank">MIT License</a> - Attribution required for use and modifications</p>
        </div>
    </footer>

    <script src="https://unpkg.com/globe.gl"></script>
    <script src="app.js"></script>
    <script>
        // Update copyright year dynamically
        document.getElementById('copyrightYear').textContent = new Date().getFullYear();
    </script>
</body>
</html>
